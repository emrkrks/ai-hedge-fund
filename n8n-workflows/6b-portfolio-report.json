{
    "name": "Portfolio Report (Part 2 - Send)",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "cronExpression",
                            "expression": "30 16 * * 1-5"
                        }
                    ]
                }
            },
            "name": "Cron (16:30)",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1,
            "position": [
                -400,
                200
            ],
            "id": "cron-trigger"
        },
        {
            "parameters": {
                "operation": "getAll",
                "tableId": "portfolio_analyses",
                "returnAll": false,
                "limit": 50,
                "filterType": "string",
                "filterString": "=created_at=gte.{{ $now.startOf('day').toISO() }}"
            },
            "name": "Get Today's Data",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -200,
                200
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "W2X8BWyusvwAEBsB",
                    "name": "Supabase account"
                }
            },
            "id": "get-data"
        },
        {
            "parameters": {
                "mode": "runOnceForAllItems",
                "jsCode": "const holdings = $input.all().map(i => i.json);\nif (!holdings.length) return [{ json: { summary_text: 'âš ï¸ BugÃ¼n iÃ§in veri bulunamadÄ±!', has_data: false } }];\n\nlet totalCost = 0, totalValue = 0, totalDailyPL = 0, totalUnrealizedPL = 0;\nconst lines = [];\n\nholdings.sort((a,b) => (b.current_value||0) - (a.current_value||0));\n\nfor (const h of holdings) {\n  totalCost += h.total_cost || 0;\n  totalValue += h.current_value || 0;\n  totalDailyPL += h.daily_pl || 0;\n  totalUnrealizedPL += h.unrealized_pl || 0;\n  \n  let plE = 'âšª';\n  if (h.unrealized_pl_percent > 20) plE = 'ğŸš€';\n  else if (h.unrealized_pl_percent > 5) plE = 'ğŸŸ¢';\n  else if (h.unrealized_pl_percent > -5) plE = 'âšª';\n  else if (h.unrealized_pl_percent > -20) plE = 'ğŸŸ¡';\n  else plE = 'ğŸ”´';\n  \n  const dE = h.daily_pl >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';\n  const rE = h.ai_signal === 'BULLISH' ? 'ğŸŸ¢' : (h.ai_signal === 'BEARISH' ? 'ğŸ”´' : 'âšª');\n  const ps = h.unrealized_pl >= 0 ? '+' : '';\n  const ds = h.daily_pl >= 0 ? '+' : '';\n  \n  lines.push(`${plE} *${h.ticker}*\\n   ğŸ’° $${(h.current_price||0).toFixed(2)} Ã— ${(h.shares||0).toFixed(2)}\\n   ğŸ“Š $${(h.total_cost||0).toFixed(0)} â†’ $${(h.current_value||0).toFixed(0)}\\n   ${dE} GÃ¼n: ${ds}$${(h.daily_pl||0).toFixed(0)}\\n   ğŸ“ˆ Top: ${ps}$${(h.unrealized_pl||0).toFixed(0)} (${ps}${(h.unrealized_pl_percent||0).toFixed(1)}%)\\n   ğŸ¤– ${rE} ${h.ai_signal||'N/A'} %${h.ai_confidence||0} â†’ ${h.recommendation||'HOLD'}`);\n}\n\nconst plPct = totalCost > 0 ? (totalUnrealizedPL/totalCost)*100 : 0;\nconst dPct = (totalValue-totalDailyPL) > 0 ? (totalDailyPL/(totalValue-totalDailyPL))*100 : 0;\n\nlet oE = 'âšª';\nif (plPct > 20) oE = 'ğŸš€';\nelse if (plPct > 5) oE = 'ğŸŸ¢';\nelse if (plPct > -5) oE = 'âšª';\nelse if (plPct > -20) oE = 'ğŸŸ¡';\nelse oE = 'ğŸ”´';\n\nconst dE = totalDailyPL >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';\nconst now = new Date();\nconst dt = now.toLocaleDateString('tr-TR', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});\n\nconst msg = `ğŸ“Š *PORTFÃ–Y GÃœNLÃœK RAPORU*\\nâ° ${dt}\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n${oE} *TOPLAM PORTFÃ–Y*\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\nğŸ’µ *YatÄ±rÄ±m:* $${totalCost.toFixed(0)}\\nğŸ’° *DeÄŸer:* $${totalValue.toFixed(0)}\\n\\n${dE} *GÃ¼nlÃ¼k:* ${totalDailyPL>=0?'+':''}$${totalDailyPL.toFixed(0)} (${totalDailyPL>=0?'+':''}${dPct.toFixed(2)}%)\\n\\nğŸ“ˆ *Toplam K/Z:* ${totalUnrealizedPL>=0?'+':''}$${totalUnrealizedPL.toFixed(0)} (${totalUnrealizedPL>=0?'+':''}${plPct.toFixed(2)}%)\\n\\nğŸ“‹ *Pozisyon:* ${holdings.length}\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸ“‹ *POZÄ°SYONLAR*\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n${lines.join('\\n\\n')}\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n_ğŸ¤– AI Hedge Fund - 17 Agent_`;\n\nreturn [{ json: { summary_text: msg, total_cost: totalCost, total_value: totalValue, total_daily_pl: totalDailyPL, total_unrealized_pl: totalUnrealizedPL, total_pl_percent: plPct, holding_count: holdings.length, has_data: true } }];"
            },
            "name": "Generate Report",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                0,
                200
            ],
            "id": "generate-report"
        },
        {
            "parameters": {
                "chatId": "-4820408060",
                "text": "={{ $json.summary_text }}",
                "additionalFields": {
                    "parse_mode": "Markdown"
                }
            },
            "name": "Send Telegram",
            "type": "n8n-nodes-base.telegram",
            "typeVersion": 1,
            "position": [
                200,
                200
            ],
            "credentials": {
                "telegramApi": {
                    "id": "3ocfCvvjIk4mgxda",
                    "name": "Telegram account"
                }
            },
            "id": "send-telegram"
        },
        {
            "parameters": {
                "tableId": "portfolio_summaries",
                "fieldsUi": {
                    "fieldValues": [
                        {
                            "fieldId": "total_cost",
                            "fieldValue": "={{ $json.total_cost }}"
                        },
                        {
                            "fieldId": "total_value",
                            "fieldValue": "={{ $json.total_value }}"
                        },
                        {
                            "fieldId": "total_daily_pl",
                            "fieldValue": "={{ $json.total_daily_pl }}"
                        },
                        {
                            "fieldId": "total_unrealized_pl",
                            "fieldValue": "={{ $json.total_unrealized_pl }}"
                        },
                        {
                            "fieldId": "total_pl_percent",
                            "fieldValue": "={{ $json.total_pl_percent }}"
                        },
                        {
                            "fieldId": "holding_count",
                            "fieldValue": "={{ $json.holding_count }}"
                        }
                    ]
                }
            },
            "name": "Save Summary",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                400,
                200
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "W2X8BWyusvwAEBsB",
                    "name": "Supabase account"
                }
            },
            "id": "save-summary"
        }
    ],
    "connections": {
        "Cron (16:30)": {
            "main": [
                [
                    {
                        "node": "Get Today's Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Today's Data": {
            "main": [
                [
                    {
                        "node": "Generate Report",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Generate Report": {
            "main": [
                [
                    {
                        "node": "Send Telegram",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Save Summary",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "active": false,
    "settings": {
        "executionOrder": "v1",
        "timezone": "Europe/Madrid"
    },
    "tags": [
        "portfolio",
        "report",
        "telegram"
    ]
}